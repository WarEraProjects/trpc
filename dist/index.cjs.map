{"version":3,"sources":["../src/index.ts","../src/trpc-client.ts"],"sourcesContent":["export type { components, operations, paths } from \"./api/warera-openapi\";\r\nexport { createTrpcClient as createTrpcLikeClient } from \"./trpc-client\";\r\nexport type { TrpcLikeClientOptions } from \"./trpc-client\";\r\nexport type { InputFor, ProcedureKey, ResponseFor, TrpcLikeClient } from \"./typed-procedures\";\r\n\r\n","import { createTRPCUntypedClient, httpBatchLink, loggerLink } from \"@trpc/client\";\r\nimport type { TrpcLikeClient } from \"./typed-procedures\";\r\n\r\nexport interface TrpcLikeClientOptions {\r\n  url: string;\r\n  apiKey?: string;\r\n  logger?: boolean;\r\n  fetch?: typeof fetch;\r\n  headers?: Record<string, string>;\r\n  maxBatchSize?: number;\r\n  batchIntervalMs?: number;\r\n}\r\n\r\ntype UntypedClient = {\r\n  query: (path: string, input: unknown) => Promise<unknown>;\r\n};\r\n\r\nfunction createRateLimitedFetch(origFetch?: typeof fetch, rateLimit = 100): typeof fetch {\r\n  const f: typeof fetch = origFetch ?? (globalThis as any).fetch;\r\n  const delayMs = Math.max(1, Math.floor(60000 / rateLimit));\r\n\r\n  type QueueItem = {\r\n    args: [RequestInfo | URL, RequestInit | undefined];\r\n    resolve: (r: Response | PromiseLike<Response>) => void;\r\n    reject: (e: unknown) => void;\r\n  };\r\n\r\n  const queue: QueueItem[] = [];\r\n  let running = false;\r\n  let lastTime = 0;\r\n\r\n  const runNext = async () => {\r\n    if (queue.length === 0) {\r\n      running = false;\r\n      return;\r\n    }\r\n    running = true;\r\n    const now = Date.now();\r\n    const elapsed = now - lastTime;\r\n    const wait = Math.max(0, delayMs - elapsed);\r\n    if (wait > 0) await new Promise((res) => setTimeout(res, wait));\r\n\r\n    const item = queue.shift()!;\r\n    lastTime = Date.now();\r\n    // cast to any to satisfy overloads on fetch implementations\r\n    f(item.args[0] as any, item.args[1])\r\n      .then(item.resolve)\r\n      .catch(item.reject)\r\n      .finally(() => {\r\n        if (queue.length > 0) {\r\n          setTimeout(runNext, 0);\r\n        } else {\r\n          running = false;\r\n        }\r\n      });\r\n  };\r\n\r\n  return ((input: RequestInfo | URL, init?: RequestInit) =>\r\n    new Promise<Response>((resolve, reject) => {\r\n      queue.push({ args: [input, init], resolve, reject });\r\n      if (!running) runNext();\r\n    })) as unknown as typeof fetch;\r\n}\r\n\r\n/**\r\n * Create a lightweight TRPC-like client proxy backed by an untyped @trpc/client.\r\n *\r\n * The returned value is a proxy that supports nested property access and function\r\n * invocation to call remote procedures. For example:\r\n *\r\n * ```ts\r\n * const client = createTrpcClient({ url: 'https://api.example' });\r\n * const result = await client.article.getById({ id: 1 });\r\n * ```\r\n *\r\n * Internally each invocation builds a dot-joined path from the accessed properties\r\n * (e.g. `article.getById`) and calls the underlying client's `query(path, input)`.\r\n *\r\n * @param options - Configuration options for the TRPC-like client\r\n * @param options.url - The base URL used by the HTTP batch link\r\n * @param options.apiKey - Optional API key to include as `x-api-key` header\r\n * @param options.logger - Pass `false` to disable the `loggerLink`\r\n * @param options.fetch - Optional fetch implementation to use for requests\r\n * @param options.headers - Additional headers to include on every request\r\n * @param options.rateLimit - Set the rate limit for requests per minute. Defaults to `200` if API key provided, otherwise default to 100\r\n * @param options.maxBatchSize - Max number of operations per HTTP batch. Set to `1` to disable batching.\r\n * @param options.batchIntervalMs - Time window to batch operations before sending.\r\n * @returns A `TrpcLikeClient` proxy which can be invoked like `client.foo.bar(input)`\r\n */\r\nexport function createTrpcClient(options: TrpcLikeClientOptions & {rateLimit?: number}): TrpcLikeClient {\r\n  const appliedRateLimit = options.rateLimit ?? (options.apiKey !== undefined ? 200 : 100);\r\n  \r\n  const client = createTRPCUntypedClient({\r\n    links: [\r\n      ...(options.logger === false ? [] : [loggerLink()]),\r\n      httpBatchLink({\r\n        url: options.url,\r\n        fetch: createRateLimitedFetch(options.fetch, appliedRateLimit),\r\n        maxURLLength: 2000,\r\n        headers() {\r\n          return {\r\n            ...(options.headers ?? {}),\r\n            ...(options.apiKey ? { \"x-api-key\": options.apiKey } : {})\r\n          };\r\n        }\r\n      })\r\n    ]\r\n  }) as unknown as UntypedClient;\r\n\r\n  const makeProxy = (parts: string[]): any =>\r\n    new Proxy(() => {}, {\r\n      get(_t, prop) {\r\n        if (typeof prop !== \"string\") return undefined;\r\n        return makeProxy([...parts, prop]);\r\n      },\r\n      async apply(_t, _thisArg, argArray) {\r\n        const path = parts.join(\".\");\r\n        const input = argArray?.[0] ?? {};\r\n        return client.query(path, input);\r\n      }\r\n    });\r\n\r\n  return makeProxy([]) as TrpcLikeClient;\r\n}\r\n"],"mappings":";;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;;;ACAA,oBAAmE;AAiBnE,SAAS,uBAAuB,WAA0B,YAAY,KAAmB;AACvF,QAAM,IAAkB,aAAc,WAAmB;AACzD,QAAM,UAAU,KAAK,IAAI,GAAG,KAAK,MAAM,MAAQ,SAAS,CAAC;AAQzD,QAAM,QAAqB,CAAC;AAC5B,MAAI,UAAU;AACd,MAAI,WAAW;AAEf,QAAM,UAAU,YAAY;AAC1B,QAAI,MAAM,WAAW,GAAG;AACtB,gBAAU;AACV;AAAA,IACF;AACA,cAAU;AACV,UAAM,MAAM,KAAK,IAAI;AACrB,UAAM,UAAU,MAAM;AACtB,UAAM,OAAO,KAAK,IAAI,GAAG,UAAU,OAAO;AAC1C,QAAI,OAAO,EAAG,OAAM,IAAI,QAAQ,CAAC,QAAQ,WAAW,KAAK,IAAI,CAAC;AAE9D,UAAM,OAAO,MAAM,MAAM;AACzB,eAAW,KAAK,IAAI;AAEpB,MAAE,KAAK,KAAK,CAAC,GAAU,KAAK,KAAK,CAAC,CAAC,EAChC,KAAK,KAAK,OAAO,EACjB,MAAM,KAAK,MAAM,EACjB,QAAQ,MAAM;AACb,UAAI,MAAM,SAAS,GAAG;AACpB,mBAAW,SAAS,CAAC;AAAA,MACvB,OAAO;AACL,kBAAU;AAAA,MACZ;AAAA,IACF,CAAC;AAAA,EACL;AAEA,UAAQ,CAAC,OAA0B,SACjC,IAAI,QAAkB,CAAC,SAAS,WAAW;AACzC,UAAM,KAAK,EAAE,MAAM,CAAC,OAAO,IAAI,GAAG,SAAS,OAAO,CAAC;AACnD,QAAI,CAAC,QAAS,SAAQ;AAAA,EACxB,CAAC;AACL;AA2BO,SAAS,iBAAiB,SAAuE;AACtG,QAAM,mBAAmB,QAAQ,cAAc,QAAQ,WAAW,SAAY,MAAM;AAEpF,QAAM,aAAS,uCAAwB;AAAA,IACrC,OAAO;AAAA,MACL,GAAI,QAAQ,WAAW,QAAQ,CAAC,IAAI,KAAC,0BAAW,CAAC;AAAA,UACjD,6BAAc;AAAA,QACZ,KAAK,QAAQ;AAAA,QACb,OAAO,uBAAuB,QAAQ,OAAO,gBAAgB;AAAA,QAC7D,cAAc;AAAA,QACd,UAAU;AACR,iBAAO;AAAA,YACL,GAAI,QAAQ,WAAW,CAAC;AAAA,YACxB,GAAI,QAAQ,SAAS,EAAE,aAAa,QAAQ,OAAO,IAAI,CAAC;AAAA,UAC1D;AAAA,QACF;AAAA,MACF,CAAC;AAAA,IACH;AAAA,EACF,CAAC;AAED,QAAM,YAAY,CAAC,UACjB,IAAI,MAAM,MAAM;AAAA,EAAC,GAAG;AAAA,IAClB,IAAI,IAAI,MAAM;AACZ,UAAI,OAAO,SAAS,SAAU,QAAO;AACrC,aAAO,UAAU,CAAC,GAAG,OAAO,IAAI,CAAC;AAAA,IACnC;AAAA,IACA,MAAM,MAAM,IAAI,UAAU,UAAU;AAClC,YAAM,OAAO,MAAM,KAAK,GAAG;AAC3B,YAAM,QAAQ,WAAW,CAAC,KAAK,CAAC;AAChC,aAAO,OAAO,MAAM,MAAM,KAAK;AAAA,IACjC;AAAA,EACF,CAAC;AAEH,SAAO,UAAU,CAAC,CAAC;AACrB;","names":[]}